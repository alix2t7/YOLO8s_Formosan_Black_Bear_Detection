name: ðŸš€ YOLOv8s Pipeline CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-format:
    name: ðŸ” ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ðŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ å®‰è£æª¢æŸ¥å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
        
    - name: ðŸ” Flake8 èªžæ³•æª¢æŸ¥
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
        
    - name: ðŸŽ¨ æª¢æŸ¥ä»£ç¢¼æ ¼å¼
      run: |
        black --check src/
        isort --check-only src/

  basic-tests:
    name: ðŸ§ª åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ðŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ðŸ“¦ å®‰è£åŸºæœ¬ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML
        
    - name: ðŸ§ª åŸ·è¡ŒåŸºæœ¬åŠŸèƒ½æ¸¬è©¦
      run: |
        python test_basic_functionality.py
        
    - name: ðŸ“‹ æª¢æŸ¥é…ç½®æª”æ¡ˆ
      run: |
        python -c "
        import yaml
        import os
        
        config_files = [
          'config/base_config.yaml',
          'config/training_config.yaml', 
          'config/optuna_config.yaml'
        ]
        
        for config_file in config_files:
          if os.path.exists(config_file):
            with open(config_file, 'r', encoding='utf-8') as f:
              config = yaml.safe_load(f)
              print(f'âœ… {config_file} è¼‰å…¥æˆåŠŸ')
          else:
            print(f'âŒ {config_file} ä¸å­˜åœ¨')
            exit(1)
        "

  documentation-check:
    name: ðŸ“š æ–‡æª”æª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼  
      uses: actions/checkout@v4
      
    - name: ðŸ” æª¢æŸ¥å¿…è¦æª”æ¡ˆ
      run: |
        echo "æª¢æŸ¥å¿…è¦æª”æ¡ˆ..."
        
        required_files=(
          "README.md"
          "LICENSE" 
          "requirements.txt"
          "CHANGELOG.md"
          "CONTRIBUTING.md"
          "main.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
    - name: ðŸ“ æª¢æŸ¥ Markdown é€£çµ
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'no'
        config-file: '.github/markdown-link-check-config.json'

  security-scan:
    name: ðŸ”’ å®‰å…¨æ€§æŽƒæ
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ðŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ”’ å®‰è£ Bandit
      run: |
        pip install bandit[toml]
        
    - name: ðŸ” åŸ·è¡Œå®‰å…¨æ€§æŽƒæ
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ || true

  dependency-check:
    name: ðŸ“¦ ä¾è³´æª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ðŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ“¦ æª¢æŸ¥ä¾è³´ç‰ˆæœ¬
      run: |
        python -c "
        import re
        
        with open('requirements.txt', 'r') as f:
          lines = f.readlines()
          
        print('æª¢æŸ¥ requirements.txt æ ¼å¼...')
        for i, line in enumerate(lines, 1):
          line = line.strip()
          if line and not line.startswith('#'):
            if not re.match(r'^[a-zA-Z0-9_-]+[>=<,.\d\s]*$', line):
              print(f'âŒ ç¬¬{i}è¡Œæ ¼å¼éŒ¯èª¤: {line}')
              exit(1)
            else:
              print(f'âœ… ç¬¬{i}è¡Œæ ¼å¼æ­£ç¢º: {line}')
        
        print('âœ… requirements.txt æ ¼å¼æª¢æŸ¥é€šéŽ')
        "

  build-status:
    name: ðŸ“Š å»ºç½®ç‹€æ…‹ç¸½çµ
    runs-on: ubuntu-latest
    needs: [lint-and-format, basic-tests, documentation-check, security-scan, dependency-check]
    if: always()
    
    steps:
    - name: ðŸ“Š æª¢æŸ¥å»ºç½®çµæžœ
      run: |
        echo "å»ºç½®ç‹€æ…‹ç¸½çµ:"
        echo "ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.lint-and-format.result }}"
        echo "åŸºæœ¬åŠŸèƒ½æ¸¬è©¦: ${{ needs.basic-tests.result }}"
        echo "æ–‡æª”æª¢æŸ¥: ${{ needs.documentation-check.result }}"
        echo "å®‰å…¨æ€§æŽƒæ: ${{ needs.security-scan.result }}"
        echo "ä¾è³´æª¢æŸ¥: ${{ needs.dependency-check.result }}"
        
        if [[ "${{ needs.lint-and-format.result }}" == "success" && 
              "${{ needs.basic-tests.result }}" == "success" && 
              "${{ needs.documentation-check.result }}" == "success" && 
              "${{ needs.dependency-check.result }}" == "success" ]]; then
          echo "ðŸŽ‰ æ‰€æœ‰æª¢æŸ¥é€šéŽ!"
        else
          echo "âŒ éƒ¨åˆ†æª¢æŸ¥å¤±æ•—"
          exit 1
        fi
