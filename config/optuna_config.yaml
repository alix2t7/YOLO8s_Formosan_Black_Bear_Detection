# Optuna è¶…åƒæ•¸å„ªåŒ–é…ç½®
# åŸºæ–¼ YOLOv8_Optuna_Optimizer.py çš„æœ€ä½³å¯¦è¸

# å„ªåŒ–åŸºæœ¬é…ç½®
optimization:
  study_name: "yolov8s_bear_detection_v2"
  storage: null                 # æ•¸æ“šåº«å­˜å„² (null è¡¨ç¤ºè¨˜æ†¶é«”å­˜å„²)
  direction: "maximize"         # å„ªåŒ–æ–¹å‘
  
  # è©¦é©—é…ç½®
  n_trials: 50                  # ç¸½è©¦é©—æ¬¡æ•¸
  timeout: null                 # è¶…æ™‚æ™‚é–“ (ç§’)
  
  # ä¸¦è¡Œé…ç½®
  n_jobs: 1                     # ä¸¦è¡Œä»»å‹™æ•¸
  
  # çµæœä¿å­˜
  save_study: true              # ä¿å­˜ç ”ç©¶çµæœ
  study_file: "optuna_study.pkl"

# æœç´¢ç­–ç•¥é…ç½®
search_strategy:
  # æ¡æ¨£å™¨é¡å‹
  sampler: "TPE"                # TPE, Random, CmaEs, GP, NSGA2
  
  # TPE ç‰¹å®šé…ç½®
  tpe:
    n_startup_trials: 10        # éš¨æ©Ÿåˆå§‹è©¦é©—æ•¸
    n_ei_candidates: 24         # EI å€™é¸é»æ•¸
    gamma: 0.25                 # gamma åƒæ•¸
    
  # ä¿®å‰ªå™¨é…ç½®
  pruning:
    enable: true                # æ˜¯å¦å•Ÿç”¨ä¿®å‰ª
    pruner: "MedianPruner"      # MedianPruner, HyperbandPruner
    
    # MedianPruner é…ç½®
    median:
      n_startup_trials: 5       # é–‹å§‹ä¿®å‰ªå‰çš„è©¦é©—æ•¸
      n_warmup_steps: 5         # ç†±èº«æ­¥æ•¸
      
    # Hyperband é…ç½®
    hyperband:
      min_resource: 10          # æœ€å°è³‡æº
      max_resource: 100         # æœ€å¤§è³‡æº

# åƒæ•¸æœç´¢ç¯„åœé…ç½®
# åŸºæ–¼åŸå§‹ä»£ç¢¼çš„åƒæ•¸ç©ºé–“å®šç¾©

parameters:
  # ğŸ”´ æœ€é«˜å„ªå…ˆåº¦åƒæ•¸ (å›ºå®šå€¼ï¼ŒåŸºæ–¼è¨“ç·´è…³æœ¬é©—è­‰)
  fixed:
    model_size: "yolov8s"       # å›ºå®šæ¨¡å‹å¤§å°
    optimizer: "AdamW"          # å›ºå®šå„ªåŒ–å™¨
    batch_size: 128             # å›ºå®šåŸºç¤æ‰¹æ¬¡å¤§å°
    img_size: 640               # å›ºå®šåœ–ç‰‡å¤§å°
    box_weight: 0.05            # å›ºå®šé‚Šç•Œæ¡†æ¬Šé‡
  
  # ğŸŸ¡ é«˜å„ªå…ˆåº¦åƒæ•¸ (éœ€è¦å„ªåŒ–)
  high_priority:
    # å­¸ç¿’ç‡ç­–ç•¥
    cos_lr:
      type: "categorical"
      choices: [true, false]
    
    lr0:
      type: "float"
      low: 2.0e-4
      high: 8.0e-4
      log: true
    
    lrf:
      type: "float"
      low: 0.05
      high: 0.15
      log: false
    
    # AdamW ç‰¹å®šåƒæ•¸
    momentum:                   # beta1 for AdamW
      type: "float"
      low: 0.88
      high: 0.92
      log: false
    
    weight_decay:
      type: "float"
      low: 3.0e-4
      high: 7.0e-4
      log: false
    
    # è¨“ç·´ç­–ç•¥
    epochs:
      type: "int"
      low: 200
      high: 280
    
    patience:
      type: "int"
      low: 25
      high: 35
    
    warmup_epochs:
      type: "float"
      low: 3.0
      high: 7.0
  
  # ğŸŸ¢ ä¸­å„ªå…ˆåº¦åƒæ•¸ (æå¤±å‡½æ•¸æ¬Šé‡)
  medium_priority:
    # åˆ†é¡æå¤±æ¬Šé‡ (å°é»‘ç†Šæª¢æ¸¬æœ€é‡è¦)
    cls_weight:
      type: "float"
      low: 1.1
      high: 1.6
      log: false
    
    # DFL æå¤±æ¬Šé‡ (YOLOv8 é‡è¦åƒæ•¸)
    dfl_weight:
      type: "float"
      low: 1.2
      high: 1.8
      log: false
    
    # è³‡æ–™å¢å¼·åƒæ•¸
    hsv_h:
      type: "float"
      low: 0.03
      high: 0.07
    
    hsv_s:
      type: "float"
      low: 0.15
      high: 0.35
    
    hsv_v:
      type: "float"
      low: 0.4
      high: 0.8
    
    degrees:
      type: "float"
      low: 12.0
      high: 25.0
    
    translate:
      type: "float"
      low: 0.25
      high: 0.5
    
    scale:
      type: "float"
      low: 0.15
      high: 0.35
  
  # ğŸ”µ ä¸­ä½å„ªå…ˆåº¦åƒæ•¸
  low_priority:
    fliplr:
      type: "float"
      low: 0.2
      high: 0.4
    
    flipud:
      type: "float"
      low: 0.2
      high: 0.45
    
    mosaic:
      type: "float"
      low: 0.05
      high: 0.15
    
    mixup:
      type: "float"
      low: 0.05
      high: 0.15

# è©•åˆ†ç­–ç•¥é…ç½®
scoring:
  # ä¸»è¦æŒ‡æ¨™
  primary_metric: "bear_focused_score"
  
  # é»‘ç†Šå°ˆç”¨è©•åˆ†é…ç½®
  bear_focused:
    # æ¬Šé‡é…ç½®
    weights:
      precision_bear: 0.3       # é»‘ç†Šç²¾ç¢ºåº¦æ¬Šé‡
      recall_bear: 0.3          # é»‘ç†Šå¬å›ç‡æ¬Šé‡
      f1_bear: 0.2              # é»‘ç†Š F1 åˆ†æ•¸æ¬Šé‡
      map50: 0.15               # mAP@0.5 æ¬Šé‡
      map95: 0.05               # mAP@0.5:0.95 æ¬Šé‡
    
    # æ‡²ç½°å› å­
    penalties:
      false_positive: 0.1       # å‡é™½æ€§æ‡²ç½°
      false_negative: 0.15      # å‡é™°æ€§æ‡²ç½° (æ›´é‡è¦)
    
    # æœ€å°é–¾å€¼
    min_thresholds:
      precision_bear: 0.7       # é»‘ç†Šæœ€å°ç²¾ç¢ºåº¦
      recall_bear: 0.6          # é»‘ç†Šæœ€å°å¬å›ç‡

# å…©éšæ®µå„ªåŒ–é…ç½®
two_stage:
  enable: true                  # æ˜¯å¦å•Ÿç”¨å…©éšæ®µå„ªåŒ–
  
  # ç¬¬ä¸€éšæ®µ: YOLOv8 å…§å»º tune()
  stage1:
    enable: true                # æ˜¯å¦å•Ÿç”¨ç¬¬ä¸€éšæ®µ
    iterations: 30              # YOLOv8 tune() è¿­ä»£æ¬¡æ•¸
    use_results: true           # æ˜¯å¦ä½¿ç”¨ç¬¬ä¸€éšæ®µçµæœ
  
  # ç¬¬äºŒéšæ®µ: Optuna ç²¾ç´°æœç´¢
  stage2:
    enable: true                # æ˜¯å¦å•Ÿç”¨ç¬¬äºŒéšæ®µ
    trials: 50                  # Optuna è©¦é©—æ¬¡æ•¸
    use_stage1_best: true       # æ˜¯å¦åŸºæ–¼ç¬¬ä¸€éšæ®µæœ€ä½³çµæœ

# æ—©åœé…ç½® (é‡å°å„ªåŒ–éç¨‹)
early_stopping:
  enable: true                  # æ˜¯å¦å•Ÿç”¨æ—©åœ
  patience: 10                  # ç„¡æ”¹å–„å®¹å¿è¼ªæ•¸
  min_delta: 0.001              # æœ€å°æ”¹å–„å¹…åº¦
  restore_best: true            # æ˜¯å¦æ¢å¾©æœ€ä½³çµæœ

# çµæœä¿å­˜é…ç½®
results:
  save_dir: "./results/optimization"
  
  # ä¿å­˜å…§å®¹
  save_study: true              # ä¿å­˜å®Œæ•´ç ”ç©¶
  save_best_params: true        # ä¿å­˜æœ€ä½³åƒæ•¸
  save_trials_df: true          # ä¿å­˜è©¦é©—æ•¸æ“šæ¡†
  save_plots: true              # ä¿å­˜å„ªåŒ–åœ–è¡¨
  
  # æ–‡ä»¶æ ¼å¼
  params_format: ["json", "yaml"]  # åƒæ•¸ä¿å­˜æ ¼å¼
  
  # åœ–è¡¨é…ç½®
  plots:
    optimization_history: true  # å„ªåŒ–æ­·å²
    param_importances: true     # åƒæ•¸é‡è¦æ€§
    parallel_coordinate: true   # å¹³è¡Œåæ¨™åœ–
    slice_plot: true            # åˆ‡ç‰‡åœ–

# ç›£æ§é…ç½®
monitoring:
  # å¯¦æ™‚ç›£æ§
  real_time: true               # å¯¦æ™‚ç›£æ§
  update_interval: 10           # æ›´æ–°é–“éš” (ç§’)
  
  # é€šçŸ¥é…ç½®
  notifications:
    enable: false               # æ˜¯å¦å•Ÿç”¨é€šçŸ¥
    methods: ["console"]        # é€šçŸ¥æ–¹å¼
    
  # è³‡æºç›£æ§
  resource_monitoring:
    enable: true                # ç›£æ§ç³»çµ±è³‡æº
    log_interval: 60            # è¨˜éŒ„é–“éš” (ç§’)

# éŒ¯èª¤è™•ç†é…ç½®
error_handling:
  # é‡è©¦ç­–ç•¥
  max_retries: 3                # æœ€å¤§é‡è©¦æ¬¡æ•¸
  retry_delay: 5                # é‡è©¦å»¶é² (ç§’)
  
  # éŒ¯èª¤é¡å‹è™•ç†
  handle_gpu_oom: true          # è™•ç† GPU è¨˜æ†¶é«”ä¸è¶³
  handle_timeout: true          # è™•ç†è¶…æ™‚éŒ¯èª¤
  handle_convergence: true      # è™•ç†æ”¶æ–‚éŒ¯èª¤
  
  # é™ç´šç­–ç•¥
  fallback_strategies:
    reduce_batch_size: true     # æ¸›å°‘æ‰¹æ¬¡å¤§å°
    switch_to_cpu: false        # åˆ‡æ›åˆ° CPU (é€šå¸¸ä¸å»ºè­°)
    reduce_image_size: false    # æ¸›å°‘åœ–ç‰‡å¤§å°
